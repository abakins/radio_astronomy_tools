# Solar system object tools 

## uvplanetfit.py 
uvplanetfit scripts serve as an alternative to the CASA task [uvmodelfit](https://casadocs.readthedocs.io/en/latest/api/tt/casatasks.manipulation.uvmodelfit.html) which is focused on models which are relevant to planets. Unlike uvmodelfit, however, it doesn't interface with MeasurementSets directly, and instead requires extraction of the relevant data using ms.getdata. Examples for this process are shown below in demonstration scripts for each function. It also creates model images for tclean's startmodel parameter instead of CASA component lists. 

### uvplanetfit
In addition to generating a uniform disk model, uvplanetfit can also fit limb-darkening and ellipsoid shape models. This function can only be used for co-polarized visibilities.

Parameters which can be fit (added via fit_params as a dictionary including starting guesses)
Other values are either assumed by default or can be added via static_params

Valid fit_params include: 
- 'Io': Disk intensity (Jy * Distance^2 / Area)
- 'r': Disk radius in radians 
- 'p': Limb darkening parameter 
- 'b': Ratio of long to short axis of disk
- 'phi': Counterclockwise rotation (in degrees) of the long axis relative to the image "l" coordinate (generally the horizontal axis)

```
# Example test 
import scipy.constants as spc 
import casatools
ms = casatools.ms()

filename='your-ms-here' 
ms.open(filename)
data = ms.getdata(['real', 'imaginary', 'u', 'v', 'uvdist', 'flag', 'axis_info', 'data_desc_id', 'scan_number'])
# Select only linear or circular polarizations 
corrs = data['axis_info']['corr_axis']
corrdex = [i for i in range(len(corrs)) if corrs[i][0] == corrs[i][1]]  # Accumulates only co-pols
data['real'] = data['real'][corrdex]
data['imaginary'] = data['imaginary'][corrdex]
data['flag'] = data['flag'][corrdex]
wavelength = spc.c / data['axis_info']['freq_axis']['chan_freq']
wavelength = wavelength.ravel()
mask = data['flag'] == False 
reals = data['real'][mask]
imags = data['imaginary'][mask]
u = data['u'][mask.ravel()] / wavelength 
v = data['v'][mask.ravel()] / wavelength
cvis = reals + 1j * imags

fit_params = {'Io': 32/(np.pi * 8e-6**2), 
                'r': 8.48e-6, 
                'p': 0.1
            }
static_params = {
                'b': 1.,
                'phi': 0., 
                }
solver_kwargs = {'bounds': [(0, np.inf), (0, np.inf), (0, 1)]}
result = uvplanetfit(cvis, u, v, fit_params=fit_params, static_params=static_params, fit_reals=True, 
                        make_plots=True, savefig='test.png', solmode='L2', solver_kwargs=solver_kwargs, compute_sigma=True, sigma_bin=101)
```

A plot generated by this routine, fit to Sub-Millimeter Array observations of Uranus, is shown below 

![Uranus SMA fit](/figures/uranus_sma_fit.png)


